#!/bin/env python
# -*- coding: utf-8 -*-
from sphinx_multibuild import SphinxMultiBuilder
import logging
import time
import sys
import argparse

if __name__ == '__main__':
    """Parse and check the command line arguments."""
    parser = argparse.ArgumentParser(
        description='Run sphinx doc build step.',
        formatter_class=argparse.RawDescriptionHelpFormatter)

    parser.add_argument('-m', '--monitor', action='store_true', dest='monitor',
                        help='Monitor for changes and autobuild')

    parser.add_argument('-q', '--quiet', action='store_true', dest='quiet',
                        help='Only print warnings and errors.')

    args = parser.parse_args()

    sphinx_args = [
        '-M', '@DOC@',
        '-c', '@SPHINX_OUTPUT_DIR@'
    ]

    if args.quiet:
        sphinx_args.append("-q")

    if '@SPHINX_WERROR@' != '':
        sphinx_args.append("-W")

    loglevel = logging.WARNING if args.quiet else logging.INFO
    logging.basicConfig(format='%(message)s', level=loglevel)

    builder = SphinxMultiBuilder([@RST_INPUT_DIRS@], "@RST_TMP_DIR@",
                                 "@SPHINX_OUTPUT_DIR@", sphinx_args)

    builder.build()

    if args.monitor:
        builder.start_autobuilding()
        try:
            while True:
                time.sleep(1)
        except KeyboardInterrupt:
            builder.stop_autobuilding()

    sys.exit(builder.get_last_exit_code())
